# rTechManager - Universal Linux Deployment (Debian/Ubuntu/Mint)
# NO-GIT ONLINE INSTALLATION

# 1. Elevate to root
sudo su

# 2. Install System Dependencies
# libpam0g-dev is CRITICAL for system account authentication
apt update
apt install -y nodejs npm tightvncserver websockify build-essential libpam0g-dev wget unzip

# 3. Download Source via GitHub ZIP (No Git needed)
mkdir -p /opt/rtechmanager
cd /opt/rtechmanager
wget https://github.com/joshuadjteam/rtechmanager/archive/refs/heads/main.zip -O source.zip
unzip -j source.zip
rm source.zip

# 4. Configure Backend
# This builds the native PAM authentication modules
npm init -y
npm install express body-parser authenticate-pam http-proxy

# 5. Initialize VNC (TightVNC)
# Run once to set password, then kill to let the service handle it
vncserver :1
vncserver -kill :1

# 6. Create Persistent SystemD Service
cat <<EOF > /etc/systemd/system/rtechmanager.service
[Unit]
Description=rTechManager Production Dashboard
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/opt/rtechmanager
ExecStart=/usr/bin/node server.js
Restart=on-failure
Environment=NODE_ENV=production

[Install]
WantedBy=multi-user.target
EOF

# 7. Enable Ports
ufw allow 1783/tcp
ufw allow 1783/udp


# 8. Launch
systemctl daemon-reload
systemctl enable rtechmanager
systemctl start rtechmanager

echo "------------------------------------------------"
echo "INSTALL COMPLETE"
echo "Access at: http://$(hostname -I | cut -d' ' -f1):1783"
echo "------------------------------------------------"
